<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>TV Guide Grid</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h1 { text-align: center; }
    .grid { display: grid; grid-template-columns: 150px repeat(3, 1fr); gap: 1px; background: #ccc; }
    .cell { background: #fff; padding: 10px; border: 1px solid #ddd; }
    .header { background: #0078D7; color: white; font-weight: bold; text-align: center; }
    .channel { background: #eee; font-weight: bold; }
  </style>
</head>
<body>
  <h1>ðŸ“º TV Guide Grid</h1>
  <div class="grid" id="epgGrid"></div>

  <script>
    const epgUrl = 'https://myeth-epg.github.io/public/epg.pw.all.xml';

    function formatHour(raw) {
      const match = raw.match(/^(\d{4})(\d{2})(\d{2})(\d{2})/);
      if (!match) return raw;
      const [_, y, mo, d, h] = match;
      return `${y}-${mo}-${d} ${h}:00`;
    }

    function getHour(raw) {
      const match = raw.match(/^(\d{4})(\d{2})(\d{2})(\d{2})/);
      return match ? parseInt(match[4]) : null;
    }

    function getCurrentHour() {
      const now = new Date();
      return now.getHours();
    }

    fetch(epgUrl)
      .then(response => response.text())
      .then(str => new window.DOMParser().parseFromString(str, "text/xml"))
      .then(data => {
        const programs = Array.from(data.querySelectorAll("programme"));
        const grid = document.getElementById("epgGrid");

        const currentHour = getCurrentHour();
        const hours = [currentHour, currentHour + 1, currentHour + 2];

        // Header row
        grid.innerHTML += `<div class="cell header">Channel</div>`;
        hours.forEach(h => {
          grid.innerHTML += `<div class="cell header">${h}:00</div>`;
        });

        // Group by channel
        const channelMap = {};
        programs.forEach(p => {
          const channel = p.getAttribute("channel");
          if (!channelMap[channel]) channelMap[channel] = [];
          channelMap[channel].push(p);
        });

        Object.entries(channelMap).forEach(([channel, items]) => {
          grid.innerHTML += `<div class="cell channel">${channel}</div>`;
          hours.forEach(h => {
            const match = items.find(p => getHour(p.getAttribute("start")) === h);
            const title = match?.querySelector("title")?.textContent || "";
            grid.innerHTML += `<div class="cell">${title}</div>`;
          });
        });
      });
  </script>
</body>
</html>
