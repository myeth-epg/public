<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta content="width=device-width,initial-scale=1" name="viewport">
  <link href="data:image/x-icon;" rel="icon">
  <title>github.com/myeth-epg</title>
  <link href="libs/shaka-controls.min.css" rel="stylesheet">
  <link href="xml-epg.css" rel="stylesheet">
  <style>
    body { margin: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; background-color: #282c34; }
    #playlist { width: 350px; background-color: #282c34; color: #fff; overflow-y: auto; border-right: 1px solid #444; padding: 20px; box-shadow: 2px 0 5px rgb(0 0 0 / .2); display: flex; flex-direction: column; }
    #search-input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #444; border-radius: 5px; background-color: #3c4043; color: #fff; font-size: 1em; box-sizing: border-box; display: none; }
    #epg-button { width: 100%; padding: 10px; margin-bottom: 10px; background-color: #61dafb; color: #000; border: none; border-radius: 5px; font-size: 1em; cursor: pointer; box-shadow: 0 4px 8px rgb(0 0 0 / .3); }
    #epg-button:hover { background-color: #4fa3c4; }
    #video-container { flex: 1; display: flex; flex-direction: column; z-index: 2; }
    #video { flex: 1; width: 100%; height: 100%; background-color: #000; }
    #video-list { list-style: none; padding: 0; margin: 0; }
    #video-list li { padding: 10px; margin: 5px 0; border-radius: 5px; cursor: pointer; transition: background-color .3s ease, transform .2s ease; display: flex; align-items: center; }
    #video-list li:hover { background-color: #61dafb; transform: scale(1.05); }
    #video-list img { width: 50px; height: 50px; margin-right: 10px; border-radius: 5px; object-fit: contain; }
    .video-title { font-size: 1em; }
    .active { background-color: #4fa3c4; }
    #overlay { display: none; flex-direction: column; align-items: center; overflow-y: auto; z-index: 2; flex: 1; }
    #epg-container { display: block; z-index: 1000; position: fixed; width: 100%; height: 100%; overflow-y: scroll; overflow-x: scroll; background-color: #282c34; }
  </style>
</head>
<body>
  <button id="enter-favourite-button" style="position: fixed; top: 10px; left: 10px; z-index: 1003; padding: 10px 15px; background-color: #61dafb; color: #000; border: none; border-radius: 5px; font-size: 1em; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,.3);" onclick="xmlepg.toggleEpgView()">Enter Favourite</button>

  <div id="playlist">
    <button id="epg-button" onclick="openEPG()">EPG</button>

    <div id="user-controls" style="margin-bottom: 10px;">
      <div style="display: flex; margin-bottom: 10px;">
        <input id="codename-input" type="text" placeholder="Enter Codename" style="flex-grow: 1; padding: 10px; border: 1px solid #444; border-radius: 5px; background-color: #3c4043; color: #fff; font-size: 1em; margin-right: 10px;">
        <button id="save-favorites-button" style="padding: 10px; background-color: #61dafb; color: #000; border: none; border-radius: 5px; font-size: 0.9em; cursor: pointer;">Save</button>
      </div>
      <button id="show-favorites-button" style="width: 49%; padding: 10px; background-color: #61dafb; color: #000; border: none; border-radius: 5px; font-size: 0.9em; cursor: pointer;">Favorites</button>
      <button id="show-all-button" style="width: 49%; padding: 10px; background-color: #61dafb; color: #000; border: none; border-radius: 5px; font-size: 0.9em; cursor: pointer; float: right;">Show All</button>
    </div>

    <input id="search-input" placeholder="Search...">
    <ul id="video-list"></ul>
  </div>
  <div id="overlay" style="display:flex"></div>

  <div id="epg-container"></div>

  <script src="libs/shaka-player.compiled.js"></script>
  <script src="libs/M3U8Interpreter.js"></script>
  <script src="libs/pako.min.js"></script>
  <script src="libs/jszip.min.js"></script>
  <script src="xml-epg.js"></script>

  <script>
    var xmlepg = new XMLEPG();
    var overlay = document.getElementById('overlay');
    var epgContainer = document.getElementById('epg-container');
    const videoList = document.getElementById('video-list');
    const searchInput = document.getElementById('search-input');
    const codenameInput = document.getElementById('codename-input');
    const saveFavoritesButton = document.getElementById('save-favorites-button');
    const showFavoritesButton = document.getElementById('show-favorites-button');
    const showAllButton = document.getElementById('show-all-button');
    let channels;
    let favoriteChannelIds = [];
    let lastActiveChannelId = null;

    document.addEventListener('DOMContentLoaded', async () => {
      epgContainer.style.display = 'block'; // Ensure EPG is visible on load
      document.getElementById('user-controls').style.display = 'none'; // Ensure user controls are hidden on load
      const defaultEPG = "https://myeth-epg.github.io/public/epg.pw.all-2t.xml";
      try {
        const response = await fetch(defaultEPG);
        if (response.ok) {
          const text = await response.text();
          const urls = [defaultEPG];
          await xmlepg.load(urls);
          await xmlepg.displayAllPrograms('epg-container', 'xmlepg');
          document.getElementById('epg-container').style.display = 'block';
          xmlepg.timelineNeedleRender();
          channels = xmlepg.channels;
          updatePlaylist(channels);
          document.getElementById('search-input').style.display = 'block';
        } else {
          console.error('Failed to fetch EPG XML.');
        }
      } catch (error) {
        console.error('Error fetching EPG XML:', error);
      }
  function updatePlaylist(channelsToDisplay) {
    videoList.innerHTML = '';
    channelsToDisplay.forEach(channel => {
      const listItem = document.createElement('li');
      listItem.style.display = 'flex';
      listItem.style.flexWrap = 'wrap'; // Allow content to wrap
      listItem.style.alignItems = 'center'; // Keep items vertically aligned
      const isFavorite = favoriteChannelIds.includes(channel.channelName);

      listItem.innerHTML = `
        <input type="checkbox" class="favorite-checkbox" data-channel-name="${channel.channelName}" ${isFavorite ? 'checked' : ''}>
        <img src="${channel.tvgLogo}" alt="${channel.channelName} logo" style="margin-left: 10px; flex-shrink: 0;">
        <span style="margin-left: 10px; white-space: normal; flex-grow: 1; flex-shrink: 1; min-width: 0;">${channel.channelName}</span>
      `;

      if (channel.tvgId === lastActiveChannelId) {
        listItem.classList.add('active');
      }

      // Handle clicking on the list item (excluding the checkbox)
      listItem.addEventListener('click', (e) => {
        if (e.target.type === 'checkbox') return; // Don't trigger if the checkbox itself was clicked

        xmlepg.displayPrograms('overlay', channel.tvgId);
        const parent = listItem.parentElement;
        const children = parent.getElementsByTagName('li');
        for (let i = 0; i < children.length; i++) {
          children[i].classList.remove('active');
        }
        listItem.classList.add('active');
        lastActiveChannelId = channel.tvgId;
      });

      // Handle checkbox changes
      const checkbox = listItem.querySelector('.favorite-checkbox');
      checkbox.addEventListener('change', (e) => {
        const channelName = e.target.dataset.channelName;
        if (e.target.checked) {
          if (!favoriteChannelIds.includes(channelName)) {
            favoriteChannelIds.push(channelName);
          }
        } else {
          const index = favoriteChannelIds.indexOf(channelName);
          if (index > -1) {
            favoriteChannelIds.splice(index, 1);
          }
        }
      });

      videoList.appendChild(listItem);
    });
  }

  function filterPlaylist(searchTerm) {
    const filteredChannels = channels.filter(channel =>
      channel.channelName.toLowerCase().includes(searchTerm.toLowerCase())
    );
    updatePlaylist(filteredChannels);
  }

  function refreshProgramGuide() {
    if (lastActiveChannelId) {
      xmlepg.displayPrograms('overlay', lastActiveChannelId);
    }
  }

  function saveFavorites() {
    const codename = codenameInput.value.trim().toUpperCase();
    if (codename) {
      localStorage.setItem('lastCodename', codename);
      localStorage.setItem(`epg_favorites_${codename}`, JSON.stringify(favoriteChannelIds));
      alert(`Favorites for ${codename} have been saved.`);
    } else {
      alert('Please enter a codename to save your favorites.');
    }
  }

  function loadFavorites() {
    const codename = codenameInput.value.trim().toUpperCase();
    if (codename) {
      localStorage.setItem('lastCodename', codename);
      const storedFavorites = localStorage.getItem(`epg_favorites_${codename}`);
      let channelsToShow = channels;
      if (storedFavorites) {
        favoriteChannelIds = JSON.parse(storedFavorites);
        channelsToShow = channels.filter(channel => favoriteChannelIds.includes(channel.channelName));
      } else {
        favoriteChannelIds = [];
        channelsToShow = []; // Show an empty list if no favorites are found
      }
      updatePlaylist(channelsToShow);
      refreshProgramGuide();
    } else {
      updatePlaylist(channels);
      if (lastActiveChannelId) {
        xmlepg.displayPrograms('overlay', lastActiveChannelId);
      }
    }
  }

  searchInput.addEventListener('input', (event) => {
    const searchTerm = event.target.value;
    filterPlaylist(searchTerm);
  });

  saveFavoritesButton.addEventListener('click', saveFavorites);
  showFavoritesButton.addEventListener('click', loadFavorites);
  showAllButton.addEventListener('click', () => {
    updatePlaylist(channels);
    refreshProgramGuide();
  });
  codenameInput.addEventListener('keyup', (event) => {
    if (event.key === 'Enter') {
      loadFavorites();
    }
  });

  // Load last used codename and favorites
  const lastCodename = localStorage.getItem('lastCodename');
  if (lastCodename) {
    codenameInput.value = lastCodename;
    loadFavorites();
  }
});

function openEPG() {
  epgContainer.style.display = 'block';
  xmlepg.timelineNeedleRender();
}
 </script>
</body>
</html>